# NGINX TLS 테스트 서버 설정
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-tls-config
  namespace: tls-lab
data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }

    http {
        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$ssl_protocol" "$ssl_cipher"';

        access_log /var/log/nginx/access.log main;
        error_log /var/log/nginx/error.log debug;

        # HTTP -> HTTPS 리다이렉트
        server {
            listen 80;
            server_name _;

            # Stub status endpoint for nginx-exporter (HTTP only)
            location /stub_status {
                stub_status;
                access_log off;
            }

            # Health check endpoint
            location /health {
                return 200 'healthy';
                add_header Content-Type text/plain;
            }

            # Redirect all other requests to HTTPS
            location / {
                return 301 https://$host$request_uri;
            }
        }

        # HTTPS 서버 (TLS 1.2/1.3)
        server {
            listen 443 ssl;
            server_name tls-server tls-server.tls-lab.svc.cluster.local;

            ssl_certificate /etc/nginx/ssl/tls.crt;
            ssl_certificate_key /etc/nginx/ssl/tls.key;
            
            # TLS 프로토콜 설정
            ssl_protocols TLSv1.2 TLSv1.3;
            ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
            ssl_prefer_server_ciphers off;
            
            # 세션 캐시
            ssl_session_cache shared:SSL:10m;
            ssl_session_timeout 1d;

            location / {
                default_type application/json;
                return 200 '{"status":"ok","message":"TLS connection successful","protocol":"$ssl_protocol","cipher":"$ssl_cipher","server_name":"$server_name"}';
            }

            location /health {
                return 200 'healthy';
                add_header Content-Type text/plain;
            }

            location /cert-info {
                default_type application/json;
                return 200 '{"ssl_protocol":"$ssl_protocol","ssl_cipher":"$ssl_cipher","ssl_session_id":"$ssl_session_id","ssl_client_verify":"$ssl_client_verify"}';
            }
        }

        # mTLS 테스트 서버 (클라이언트 인증서 필요)
        server {
            listen 8443 ssl;
            server_name mtls-server;

            ssl_certificate /etc/nginx/ssl/tls.crt;
            ssl_certificate_key /etc/nginx/ssl/tls.key;
            ssl_client_certificate /etc/nginx/ssl/ca.crt;
            ssl_verify_client on;

            ssl_protocols TLSv1.2 TLSv1.3;

            location / {
                default_type application/json;
                return 200 '{"status":"ok","message":"mTLS connection successful","client_dn":"$ssl_client_s_dn","client_verify":"$ssl_client_verify"}';
            }
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tls-server
  namespace: tls-lab
  labels:
    app: tls-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tls-server
  template:
    metadata:
      labels:
        app: tls-server
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9113"
    spec:
      containers:
        - name: nginx
          image: nginx:1.25-alpine
          ports:
            - containerPort: 80
              name: http
            - containerPort: 443
              name: https
            - containerPort: 8443
              name: mtls
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
            - name: tls-certs
              mountPath: /etc/nginx/ssl/tls.crt
              subPath: tls.crt
            - name: tls-certs
              mountPath: /etc/nginx/ssl/tls.key
              subPath: tls.key
            - name: ca-cert
              mountPath: /etc/nginx/ssl/ca.crt
              subPath: ca.crt
          resources:
            requests:
              memory: "64Mi"
              cpu: "100m"
            limits:
              memory: "128Mi"
              cpu: "200m"
        - name: nginx-exporter
          image: nginx/nginx-prometheus-exporter:0.11
          args:
            - -nginx.scrape-uri=http://localhost:80/stub_status
          ports:
            - containerPort: 9113
              name: metrics
      volumes:
        - name: nginx-config
          configMap:
            name: nginx-tls-config
        - name: tls-certs
          secret:
            secretName: tls-server-secret
        - name: ca-cert
          secret:
            secretName: tls-lab-ca-secret
            items:
              - key: ca.crt
                path: ca.crt
---
apiVersion: v1
kind: Service
metadata:
  name: tls-server
  namespace: tls-lab
  labels:
    app: tls-server
spec:
  selector:
    app: tls-server
  ports:
    - name: http
      port: 80
      targetPort: 80
    - name: https
      port: 443
      targetPort: 443
    - name: mtls
      port: 8443
      targetPort: 8443
    - name: metrics
      port: 9113
      targetPort: 9113
  type: ClusterIP
